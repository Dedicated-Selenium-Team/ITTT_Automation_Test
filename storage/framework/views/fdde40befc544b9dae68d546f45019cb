
<?php $__env->startSection('content'); ?>

<div class="admin">
  <nav>
    <ul class="admin-ul">
      <li class="admin-list">
        <a href="/admin" class="admin-menu">ADD USER</a>
      </li>
      <li class="admin-list">
        <a href="/admin/add-details" class="admin-menu">ADD DETAILS</a>
      </li>
    </ul>
  </nav>
  <div class="admin-info">
    <button type="button" class="btn btn-info" id="admin-user" value="add">ADD NEW + </button>
    <input type="text" name="search" id="search" class="form-control" placeholder="search">
    <?php echo $__env->make('admin.new-user', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
    <div class="user-details">
      <table>
        <thead>
          <tr>
            <th>User Id</th>
            <th>Employee Name</th>
            <th>Email</th>
            <th>Designation</th>
            <th>Date of Joining</th>
            <th>Role</th>
            <th>Edit</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody class="table-body">
          <?php $count = 1;?>
          <?php foreach($users_info as $user): ?>
          <tr id="user<?php echo e($user->user_id); ?>">
            <td><?php echo e($user->user_id); ?></td>
            <td><span class="name-capital"><?php echo e($user->first_name); ?></span> <span class="name-capital"><?php echo e($user->last_name); ?></span></td>
            <td><?php echo e($user->username); ?></td>
            <td>
              <?php foreach($designation as $key => $value): ?>
              <?php if($user->UserDetails['designation_id'] == $key): ?>
              <?php echo e($value); ?>

              <?php endif; ?>
              <?php endforeach; ?>
            </td>
            <td><?php echo e($user->UserDetails['joining_date']); ?></td>
            <td>
              <?php foreach($roles as $key => $value): ?>
              <?php if($user->role_id == $key): ?>
              <?php echo e($value); ?>

              <?php endif; ?>
              <?php endforeach; ?>
            </td>
            <td>
              <button type="button" class="btn btn-edit edit" id="edit-user" data-id="<?php echo e($user->user_id); ?>">Edit User</button>

            </td>
            <td>
              <button type="button" class="btn btn-delete confirm" id="delete-user" data-id="<?php echo e($user->user_id); ?>" data-toggle="modal" data-target="#confirm-delete">Delete User</button>
              <input type="hidden" name="_token" value="<?php echo e(csrf_token()); ?>">
            </td>
          </tr>
          <?php $count += 1;?>
          <?php endforeach; ?>
        </tbody>
      </table>
    </div>
  </div>
</div>


<?php /* Modal for Delete start here */ ?>
<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Confirm Delete</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete?</p>
        <p>Do you want to proceed?</p>
        <p class="debug-url"></p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <a class="btn btn-danger btn-ok" id="btnYes">Delete</a>
      </div>
    </div>
  </div>
</div>
<?php /* Modal for delete ends here */ ?>

<script type="text/javascript">
$.ajaxSetup({
  headers : {
    'X-CSRF-TOKEN' : $('meta[name = "_token"]').attr('contents')
  }
});

/****  Create functionality ****/
$("#admin-user").on('click',function(e){
  clearForm("#user");
  $('#save').val('Add');
  $("#user").modal('show');
});

function clearForm(form)
{
  $(":input", form).each(function()
  {
    var type = this.type;
    var tag = this.tagName.toLowerCase();
    if (type == 'text')
    {
      this.value = "";
    }
  });
};

/*** update and add ***/
$('#frm-create-user').on('submit', function(e){
  e.preventDefault();
  // $('#frm-create-user').validator();

  var e_id = $('#u_id').val();
  var form = $('#frm-create-user');
  var frmData = form.serialize();
  var url = form.attr('action');
  var state = $('#save').val();
  var type = 'post';
  if (state == 'update') {
    type = 'put';
    url = url + '/' + e_id;
  }
  $.ajax({
    type : type,
    url : url,
    data : frmData,
    success : function(data){
      console.log(data);
      var role = "";
      if (data.user.role_id == 1) {
        data.user.role_id = "Admin";
      }
      if (data.user.role_id == 2) {
        data.user.role_id = "User";
      }
      else {
        data.user.role_id = "Please Select";
      }
      var designation = data.user_detail.designation_id;
      switch (designation) {
        case "1":
        data.user_detail.designation_id = "Developer";
        break;
        case "2":
        data.user_detail.designation_id = "Quality Analyst";
        break;
        case "3":
        data.user_detail.designation_id = "Project Manager";
        break;
        case "4":
        data.user_detail.designation_id = "Design team";
        break;
        default:
      }
      var row = '<tr id="user' + data.user.user_id + '">'+
      '<td>'+data.user.user_id +'</td>'+
      '<td>' + '<span class="name-capital">' + data.user.first_name + '</span>' + ' ' +
      '<span class="name-capital">' + data.user.last_name + '</span>' + '</td>'+
      '<td>'+data.user.username +'</td>'+
      '<td>'+data.user_detail.designation_id +'</td>'+
      '<td>' + data.user_detail.joining_date + '</td>' +
      '<td>' + data.user.role_id + '</td>' +
      '<td>' + '<button type="button" class="btn btn-edit edit" id="edit-user" data-id="' + data.user.user_id + '">Edit User</button>' + '</td>' +
      '<td>' + '<button type="button" class="btn btn-delete confirm" id="delete-user" data-id="' + data.user.user_id + '" data-toggle="modal" data-target="#confirm-delete">Delete User</button>' + '</td>'
      '</tr>';
      if (state == 'Add') {
        $('.table-body').append(row);
        console.log("new");
      }
      else {
        $('#user' + data.user.user_id).replaceWith(row);
        console.log("change");
      }
      $("#user").modal('hide');
    }
  });
});

/****  Edit functionality ****/
$('tbody').delegate('.btn-edit', 'click', function(){
  var value = $(this).data('id');
  console.log('value ' , value);
  var url = '<?php echo e(URL::to('admin-edit-user')); ?>';
  $.ajax({
    type : 'get',
    url : url,
    data : {'id':value},
    success : function(data){
      console.log('data ' , data);
      $('#u_id').val(data.user_id);
      $('#fname').val(data.first_name);
      $('#lname').val(data.last_name);
      $('#email').val(data.username);
      console.log('data.user_details.designation_id ' , data.user_details.designation_id);
      if (data.user_details.designation_id == 0 ) {
        $('#designation').val('');
      }
      else {
        $('#designation').val(data.user_details.designation_id);
        console.log("Not hit");
      }
      $('#qualification').val(data.user_details.qualification);
      $('#address').val(data.user_details.address);
      $('#mobile_no').val(data.user_details.mobile_no);
      $('#alt_no').val(data.user_details.alternate_no);
      $('#joining_date').val(data.user_details.joining_date);
      if (data.role_id == 0 ) {
        $('#role').val();
      }
      else{
        $('#role').val(data.role_id);
      }
      $('#save').val('update');
      $("#user").modal('show');
    }
  });
});

/****  Delete functionality ****/

$('tbody').delegate('.btn-delete', 'click', function(){
  var value = $(this).data('id');
  console.log(value);
  var url = '<?php echo e(URL::to('admin-delete-user')); ?>';

  $('#btnYes').click(function() {
    $.ajax({
      type : 'post',
      url : url + '/' + value,
      data : {
        'id':value ,
        "_token": "<?php echo e(csrf_token()); ?>"
      },
      success : function(data){
        $('#user' + value).remove();
        $("#confirm-delete").modal('hide');
      }
    });
  });
});

/****************** Search functionality *********************/
$('#search').on('keyup', function() {
  $value = $(this).val();
  $.ajax({
    type : 'get',
    url : '<?php echo e(URL::to('search')); ?>',
    data : { 'search' : $value },
    success : function(data) {
      $('.table-body').html(data);
    }
  });
});
</script>
<?php $__env->stopSection(); ?>

<?php echo $__env->make('master', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>